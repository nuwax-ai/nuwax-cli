services:
  frontend:
    image: ${DOCKER_REGISTRY}/agent-platform-front:${FRONTEND_VERSION}
    ports:
      - "${FRONTEND_HOST_PORT}:80"
    volumes:
      - ./config/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./app/front:/app/nginx/html:ro
      - ./upload:/app/upload
    depends_on:
      backend:
        condition: service_healthy
    environment:
      - NODE_ENV=production
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/index.html"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - agent-network


  backend:
    image: ${DOCKER_REGISTRY}/agent-platform-backend:${BACKEND_VERSION}
    ports:
      - "8080:${APP_PORT}"
      - "5005:${APP_DEBUG_PORT}"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus:
        condition: service_healthy
    environment:
      - JAVA_OPTS=-server -Xms2024m -Xmx2024m -XX:MaxMetaspaceSize=256m -XX:MaxMetaspaceFreeRatio=70
      - APP_PROFILE=${APP_PROFILE}
      - APP_PORT=${APP_PORT}
      - APP_DEBUG_PORT=${APP_DEBUG_PORT}
      - ENABLE_DEBUG=false
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - MILVUS_HOST=${MILVUS_HOST}
      - MILVUS_PORT=${MILVUS_PORT}
      - MILVUS_URI=${MILVUS_URI}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_PORT=${MYSQL_PORT}
      - DORIS_HOST=${DORIS_HOST}
      - DORIS_PORT=${DORIS_PORT}
      - DORIS_USER=${DORIS_USER}
      - DORIS_PASSWORD=${DORIS_PASSWORD}
      - DORIS_DB=${DORIS_DB}
      - DORIS_ROOT_USERNAME=${DORIS_ROOT_USERNAME}
    volumes:
      - ./app/app.jar:/app/app.jar:ro
      - ./config/docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - ./config/application-external.yml:/app/config/application-external.yml:ro
      - ./logs/agent:/app/logs
      - ./upload:/app/upload
      - ./data/jwt/:/app/config/jwt
    entrypoint: ["/bin/bash", "-c", "/docker-entrypoint.sh 2>&1 | tee -a /app/logs/start.log"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${APP_PORT}/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: always
    networks:
      - agent-network


  mcp-proxy:
    image: ${DOCKER_REGISTRY}/mcp-proxy:${MCP_PROXY_VERSION}
    ports:
      - "8020:8089"
    volumes:
      - ./logs/mcp_proxy:/app/logs
      - ./config/mcp_config.yml:/app/config.yml:ro
      - ./data/uv_cache/uv:/root/.cache/uv
      - ./data/npx_cache/.npm:/root/.npm
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: always
    networks:
      - agent-network

  # MySQLæƒé™ä¿®å¤å®¹å™¨ï¼ˆä¸€æ¬¡æ€§è¿è¡Œï¼‰
  mysql-permission-fix:
    image: busybox:1.36-uclibc  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬è€Œélatest
    labels:
      - "com.docker.compose.project=mysql-permission-fix"
      - "description=MySQLæƒé™ä¿®å¤åˆå§‹åŒ–å®¹å™¨"
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 32M
        reservations:
          cpus: '0.05'
          memory: 16M
    environment:
      - MYSQL_UID=${MYSQL_UID:-999}
      - MYSQL_GID=${MYSQL_GID:-999}
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./logs/mysql:/var/log/mysql
      - ./config/mysql.cnf:/tmp/mysql.cnf:rw  # æŒ‚è½½é…ç½®æ–‡ä»¶ç”¨äºæƒé™æ£€æŸ¥å’Œä¿®å¤
    command: |
      sh -c "
      set -e
      echo 'ğŸ”§ å¼€å§‹ä¿®å¤MySQLæƒé™é—®é¢˜...'
      echo 'ğŸ“‹ å½“å‰ç”¨æˆ·: '$$(id)
      echo 'ğŸ”§ ç›®æ ‡MySQLç”¨æˆ·: ${MYSQL_UID:-999}:${MYSQL_GID:-999}'
      
      # åˆ›å»ºå¿…è¦ç›®å½•
      echo 'ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•...'
      mkdir -p /var/lib/mysql /var/log/mysql
      
      # è®¾ç½®æ•°æ®ç›®å½•æƒé™ç»™mysqlç”¨æˆ·(999)
      echo 'ğŸ”‘ è®¾ç½®æ•°æ®ç›®å½•æƒé™...'
      chown -R ${MYSQL_UID:-999}:${MYSQL_GID:-999} /var/lib/mysql /var/log/mysql
      chmod -R 755 /var/lib/mysql /var/log/mysql
      
      # æ£€æŸ¥å’Œä¿®å¤é…ç½®æ–‡ä»¶æƒé™
      echo 'ğŸ”’ æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™...'
      if [ -f '/tmp/mysql.cnf' ]; then
        CURRENT_PERM=\$$(stat -c '%a' /tmp/mysql.cnf 2>/dev/null || stat -f '%Lp' /tmp/mysql.cnf 2>/dev/null)
        echo 'ğŸ“„ å½“å‰é…ç½®æ–‡ä»¶æƒé™: '\$${CURRENT_PERM}
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºç»„å†™å…¥æˆ–å…¨å±€å†™å…¥æƒé™ï¼ˆä¼šè¢«MySQLå¿½ç•¥ï¼‰
        if [ \"\$${CURRENT_PERM}\" = '775' ] || [ \"\$${CURRENT_PERM}\" = '777' ] || [ \"\$${CURRENT_PERM}\" = '664' ]; then
          echo 'âš ï¸  é…ç½®æ–‡ä»¶æƒé™ä¸å®‰å…¨ï¼ŒMySQLä¼šå¿½ç•¥æ­¤é…ç½®æ–‡ä»¶'
          echo 'ğŸ”§ ä¿®å¤é…ç½®æ–‡ä»¶æƒé™ä¸º644...'
          chmod 644 /tmp/mysql.cnf
          echo 'âœ… é…ç½®æ–‡ä»¶æƒé™å·²ä¿®å¤ä¸º644'
        else
          echo 'âœ… é…ç½®æ–‡ä»¶æƒé™æ­£å¸¸'
        fi
        
        # æ˜¾ç¤ºä¿®å¤åçš„æƒé™
        FIXED_PERM=\$$(stat -c '%a' /tmp/mysql.cnf 2>/dev/null || stat -f '%Lp' /tmp/mysql.cnf 2>/dev/null)
        echo 'ğŸ“„ ä¿®å¤åé…ç½®æ–‡ä»¶æƒé™: '\$${FIXED_PERM}
      else
        echo 'âš ï¸  é…ç½®æ–‡ä»¶ /tmp/mysql.cnf ä¸å­˜åœ¨'
      fi
      
      # éªŒè¯æƒé™è®¾ç½®
      echo 'ğŸ” éªŒè¯æƒé™è®¾ç½®...'
      echo 'ğŸ“ MySQLæ•°æ®ç›®å½•: '$$(ls -ld /var/lib/mysql)
      echo 'ğŸ“ MySQLæ—¥å¿—ç›®å½•: '$$(ls -ld /var/log/mysql)
      
      # æ£€æŸ¥ç°æœ‰æ•°æ®
      if [ -n \"$$(find /var/lib/mysql -name '*.ibd' -o -name '*.MYD' -o -name '*.MYI' 2>/dev/null)\" ]; then
        echo 'ğŸ“Š æ£€æµ‹åˆ°ç°æœ‰MySQLæ•°æ®æ–‡ä»¶ï¼Œæƒé™å·²ä¿®å¤'
      else
        echo 'ğŸ“­ æœªæ£€æµ‹åˆ°ç°æœ‰æ•°æ®æ–‡ä»¶ï¼Œè¿™æ˜¯é¦–æ¬¡åˆå§‹åŒ–'
      fi
      
      echo 'âœ… MySQLæƒé™ä¿®å¤å®Œæˆ'
      echo 'ğŸ¯ æ‘˜è¦:'
      echo '   â€¢ æ•°æ®ç›®å½•: /var/lib/mysql (755, ${MYSQL_UID:-999}:${MYSQL_GID:-999})'
      echo '   â€¢ æ—¥å¿—ç›®å½•: /var/log/mysql (755, ${MYSQL_UID:-999}:${MYSQL_GID:-999})'
      echo '   â€¢ é…ç½®æ–‡ä»¶: mysql.cnf (644, å®‰å…¨æƒé™)'
      "
    restart: "no"
    networks:
      - agent-network

  mysql:
    image: mysql:8.0
    # ä¾èµ–æƒé™ä¿®å¤å®¹å™¨
    depends_on:
      mysql-permission-fix:
        condition: service_completed_successfully
    ports:
      - "13306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - TZ=Asia/Shanghai
      - MYSQL_CHARSET=utf8mb4
      - MYSQL_COLLATION=utf8mb4_unicode_ci
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/mysql.cnf:/etc/mysql/conf.d/mysql.cnf:ro
      - ./config/init_mysql.sql:/docker-entrypoint-initdb.d/1_init_mysql.sql:ro
      - ./config/init_mysql_data.sql:/docker-entrypoint-initdb.d/2_init_mysql_data.sql:ro
      - ./logs/mysql:/var/log/mysql
    command: >
      --authentication-policy=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --init-connect='SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci; SET character_set_client=utf8mb4; SET character_set_connection=utf8mb4; SET character_set_results=utf8mb4;'
      --explicit_defaults_for_timestamp=true
      --lower_case_table_names=1
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: always
    networks:
      - agent-network

  redis:
    image: redis:7.0
    ports:
      - "16379:6379"
    environment:
      - TZ=Asia/Shanghai
    command: redis-server /usr/local/etc/redis/redis.conf --port 6379 --requirepass 123456
    volumes:
      - ./data/redis:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - ./logs/redis:/data/logs/redis
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "6379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always
    networks:
      - agent-network

  milvus:
    image: milvusdb/milvus:v2.5.8
    ports:
      - "19530:19530"
      - "9091:9091"
      - "2379:2379"
    environment:
      - TZ=Asia/Shanghai
      - ETCD_USE_EMBED=true
      - ETCD_DATA_DIR=/var/lib/milvus/etcd
      - ETCD_CONFIG_PATH=/milvus/configs/embedEtcd.yaml
      - COMMON_STORAGETYPE=local
      - TIMEZONE=Asia/Shanghai
      # å¼ºåˆ¶è®¾ç½®æ—¥å¿—çº§åˆ«
      - LOG_LEVEL=error
      - MILVUS_LOG_LEVEL=error
      # å¼ºåˆ¶ç¦ç”¨æ ‡å‡†è¾“å‡ºæ—¥å¿—
      - LOG_STDOUT=false
      - LOG_FILE_ROOTPATH=/var/log/milvus
    volumes:
      - ./data/milvus/data:/var/lib/milvus/data
      - ./data/milvus/etcd:/var/lib/milvus/etcd
      - ./config/milvus/embedEtcd.yaml:/milvus/configs/embedEtcd.yaml:ro
      - ./config/milvus/user.yaml:/milvus/configs/user.yaml:ro
      - ./config/milvus/milvus.yaml:/milvus/configs/milvus.yaml:ro
      - ./logs/milvus:/var/log/milvus
    command: ["milvus", "run", "standalone"]
    security_opt:
      - seccomp:unconfined
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 20s
      retries: 3
      start_period: 90s
    restart: always
    networks:
      - agent-network

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000" # API port
      - "9001:9001" # Console port
    volumes:
      - ./data/minio:/data # ç¡®ä¿æ­¤è·¯å¾„é€‚åˆæ‚¨çš„é¡¹ç›®ç»“æ„
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER} 
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - TZ=Asia/Shanghai
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    networks:
      - agent-network

  minio-init:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      chmod +x /scripts/init-minio.sh && 
      /scripts/init-minio.sh
      "
    volumes:
      - ./script:/scripts # å°†è„šæœ¬ç›®å½•æŒ‚è½½åˆ°å®¹å™¨ä¸­
    environment:
      - MINIO_SERVER_URL=http://minio:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET_NAME=quickwit-indexes # æ‚¨æƒ³è¦åˆ›å»ºçš„æ¡¶å
    networks:
      - agent-network
    restart: "no" # è„šæœ¬æ‰§è¡Œä¸€æ¬¡åé€€å‡º

  log_platform:
    image: ${DOCKER_REGISTRY}/log-platform:${LOG_PLATFORM_VERSION}
    ports:
      - "${LOG_PLATFORM_HOST_PORT:-8097}:8097"
    volumes:
      - ./logs/log_platform:/app/logs
      - ./config/log_platform_config.yml:/app/config.yml:ro
    environment:
      - TZ=Asia/Shanghai
    # å¦‚æœ log_platform éœ€è¦ä¾èµ–å…¶ä»–æœåŠ¡ï¼Œè¯·åœ¨æ­¤å¤„æ·»åŠ 
    depends_on:
      quickwit:
        condition: service_healthy
    # æ™ºèƒ½å¥åº·æ£€æŸ¥ï¼šåŒæ—¶æ£€æŸ¥è‡ªèº«æœåŠ¡å’Œä¾èµ–æœåŠ¡
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8097/health"] # è¯·æ ¹æ®å®é™…å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¿®æ”¹
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s # æ ¹æ®åº”ç”¨å¯åŠ¨æ—¶é—´è°ƒæ•´
    restart: always
    networks:
      - agent-network

  quickwit:
    image: quickwit/quickwit:latest
    ports:
      - "7280:7280"
      - "7281:7281"
    depends_on:
      minio:
        condition: service_healthy
    environment:
      - TZ=Asia/Shanghai
      - QW_S3_ENDPOINT=http://minio:9000
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER} # æ·»åŠ AWSæ ‡å‡†å‡­è¯å˜é‡
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD} # æ·»åŠ AWSæ ‡å‡†å‡­è¯å˜é‡
      - QW_S3_FLAVOR=minio
      # - QW_S3_REGION=us-east-1 # å–æ¶ˆæ³¨é‡Šå¹¶ç¡®ä¿è®¾ç½®
      - AWS_REGION=us-east-1 # ä¿æŒä¸QW_S3_REGIONä¸€è‡´
      - QW_S3_FORCE_PATH_STYLE_ACCESS=true
      - QW_METASTORE_URI=s3://quickwit-indexes
      - QW_DEFAULT_INDEX_ROOT_URI=s3://quickwit-indexes/ # ç¤ºä¾‹å­˜å‚¨æ¡¶ï¼Œè¯·ç¡®ä¿åœ¨ MinIO ä¸­åˆ›å»º
    volumes:
      - ./data/quickwit:/quickwit/qwdata # å¦‚æœæ‰€æœ‰æ•°æ®éƒ½å­˜å‚¨åˆ°S3ï¼Œæ­¤å·å¯èƒ½ä¸å†éœ€è¦
      - ./logs/quickwit:/quickwit/logs
      # - ./config/quickwit/quickwit.yaml:/quickwit/config/quickwit.yaml:ro
    command: ["run"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7280/api/v1/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: always
    networks:
      - agent-network


networks:
  agent-network:
    driver: bridge
    # ä»¥ä¸‹é…ç½®å¯èƒ½æœ‰åŠ©äºè§£å†³ openEuler ä¸Šçš„ç½‘ç»œé—®é¢˜  
    driver_opts:
      com.docker.network.bridge.name: agent-bridge
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      # ç¦ç”¨IPv6
      com.docker.network.enable_ipv6: "false"