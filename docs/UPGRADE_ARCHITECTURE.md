# Duck CLI æ™ºèƒ½å‡çº§ç³»ç»Ÿæ¶æ„

## ğŸ“‹ æ¦‚è¿°

Duck CLI 2.0 é‡‡ç”¨å…¨æ–°çš„æ™ºèƒ½å‡çº§æ¶æ„ï¼Œæ”¯æŒæ¶æ„ç‰¹å®šå’Œå¢é‡å‡çº§ï¼Œå¤§å¹…æå‡å‡çº§æ•ˆç‡å’Œç”¨æˆ·ä½“éªŒã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "Client Side"
        A[Duck CLI] --> B[Architecture Detector]
        A --> C[Upgrade Strategy Manager]
        A --> D[Download Manager]
        A --> E[Patch Executor]
        A --> F[Version Manager]
    end
    
    subgraph "Server Side"
        G[Enhanced Service Manifest]
        H[Platform Packages]
        I[Patch Packages]
    end
    
    subgraph "Upgrade Flow"
        J[1. Detect Architecture]
        K[2. Fetch Manifest]
        L[3. Strategy Analysis]
        M[4. Download Package]
        N[5. Apply Changes]
        O[6. Verify Result]
    end
    
    B --> J
    C --> L
    D --> M
    E --> N
    F --> O
    
    A --> G
    G --> H
    G --> I
```

## ğŸ” æ ¸å¿ƒç»„ä»¶

### 1. Architecture Detector (æ¶æ„æ£€æµ‹å™¨)

**åŠŸèƒ½**ï¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ¶æ„
```rust
pub enum Architecture {
    X86_64,    // Intel/AMD 64ä½
    Aarch64,   // ARM 64ä½ (Apple Silicon)
    Unsupported(String),
}
```

**æ£€æµ‹é€»è¾‘**ï¼š
- ä½¿ç”¨ `std::env::consts::ARCH` è·å–ç³»ç»Ÿæ¶æ„
- æ”¯æŒ x86_64 å’Œ aarch64 ä¸¤ç§ä¸»æµæ¶æ„
- æä¾›æ¶æ„å­—ç¬¦ä¸²è½¬æ¢åŠŸèƒ½

### 2. Version Manager (ç‰ˆæœ¬ç®¡ç†å™¨)

**åŠŸèƒ½**ï¼šç®¡ç†å››æ®µå¼ç‰ˆæœ¬å·ç³»ç»Ÿ
```
ç‰ˆæœ¬æ ¼å¼: major.minor.patch.build
ç¤ºä¾‹: 0.0.13.2
â”œâ”€â”€ 0.0.13  # åŸºç¡€ç‰ˆæœ¬
â””â”€â”€ .2      # è¡¥ä¸çº§åˆ«
```

**æ ¸å¿ƒé€»è¾‘**ï¼š
- ç‰ˆæœ¬è§£æå’Œæ¯”è¾ƒ
- åŸºç¡€ç‰ˆæœ¬æå–
- è¡¥ä¸é€‚ç”¨æ€§æ£€æŸ¥
- ç‰ˆæœ¬å…¼å®¹æ€§éªŒè¯

### 3. Upgrade Strategy Manager (å‡çº§ç­–ç•¥ç®¡ç†å™¨)

**åŠŸèƒ½**ï¼šæ™ºèƒ½é€‰æ‹©æœ€ä¼˜å‡çº§ç­–ç•¥

```rust
pub enum UpgradeStrategy {
    NoUpgrade { current_version: String },
    FullUpgrade { 
        from_version: String,
        to_version: String,
        architecture: String,
        download_url: String,
        signature: String,
    },
    PatchUpgrade {
        from_version: String,
        to_version: String,
        architecture: String,
        download_url: String,
        hash: String,
        signature: String,
    },
    LegacyUpgrade {
        from_version: String,
        to_version: String,
        download_url: String,
    },
}
```

**å†³ç­–é€»è¾‘**ï¼š
1. å¼ºåˆ¶å…¨é‡å‡çº§æ£€æŸ¥
2. åŸºç¡€ç‰ˆæœ¬å˜åŒ–æ£€æŸ¥
3. å¢é‡å‡çº§å¯ç”¨æ€§æ£€æŸ¥
4. æ¶æ„å…¼å®¹æ€§éªŒè¯
5. å›é€€åˆ°ä¼ ç»Ÿå‡çº§

### 4. Download Manager (ä¸‹è½½ç®¡ç†å™¨)

**åŠŸèƒ½**ï¼šæ™ºèƒ½ä¸‹è½½å’Œç¼“å­˜ç®¡ç†

**ç‰¹æ€§**ï¼š
- æ¶æ„ç‰¹å®šåŒ…ä¸‹è½½
- æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- æ•°å­—ç­¾åéªŒè¯
- è¿›åº¦å®æ—¶åé¦ˆ
- æ™ºèƒ½ç¼“å­˜ç­–ç•¥

### 5. Patch Executor (è¡¥ä¸æ‰§è¡Œå™¨)

**åŠŸèƒ½**ï¼šå®‰å…¨çš„å¢é‡å‡çº§æ‰§è¡Œ

**æ ¸å¿ƒæ¨¡å—**ï¼š
```
patch_executor/
â”œâ”€â”€ mod.rs              # ä¸»æ‰§è¡Œå™¨
â”œâ”€â”€ file_operations.rs  # æ–‡ä»¶æ“ä½œ
â”œâ”€â”€ patch_processor.rs  # è¡¥ä¸å¤„ç†
â””â”€â”€ error.rs           # é”™è¯¯å¤„ç†
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. è¡¥ä¸åŒ…ä¸‹è½½å’ŒéªŒè¯
2. åˆ›å»ºç³»ç»Ÿå¤‡ä»½
3. è§£å‹è¡¥ä¸åŒ…
4. æ‰§è¡Œæ–‡ä»¶æ›¿æ¢æ“ä½œ
5. æ‰§è¡Œæ–‡ä»¶åˆ é™¤æ“ä½œ
6. éªŒè¯æ‰§è¡Œç»“æœ
7. æ¸…ç†ä¸´æ—¶æ–‡ä»¶

## ğŸ”„ å‡çº§æµç¨‹å›¾

### æ™ºèƒ½å‡çº§å†³ç­–æµç¨‹

```mermaid
flowchart TD
    A[å¼€å§‹å‡çº§] --> B[æ£€æµ‹ç³»ç»Ÿæ¶æ„]
    B --> C[è·å–æœåŠ¡å™¨æ¸…å•]
    C --> D{å¼ºåˆ¶å…¨é‡å‡çº§?}
    D -->|æ˜¯| E[é€‰æ‹©å…¨é‡å‡çº§]
    D -->|å¦| F[æ£€æŸ¥åŸºç¡€ç‰ˆæœ¬å˜åŒ–]
    F -->|ç‰ˆæœ¬å˜åŒ–| E
    F -->|ç‰ˆæœ¬ç›¸åŒ| G[æ£€æŸ¥å¢é‡å‡çº§å¯ç”¨æ€§]
    G -->|å¯ç”¨| H[é€‰æ‹©å¢é‡å‡çº§]
    G -->|ä¸å¯ç”¨| I[æ£€æŸ¥ç‰ˆæœ¬å…³ç³»]
    I -->|å½“å‰ç‰ˆæœ¬>=ç›®æ ‡ç‰ˆæœ¬| J[æ— éœ€å‡çº§]
    I -->|éœ€è¦å‡çº§| K[å›é€€ä¼ ç»Ÿå‡çº§]
    
    E --> L[æ‰§è¡Œå…¨é‡å‡çº§]
    H --> M[æ‰§è¡Œå¢é‡å‡çº§]
    K --> N[æ‰§è¡Œä¼ ç»Ÿå‡çº§]
    J --> O[å®Œæˆ]
    L --> O
    M --> O
    N --> O
```

### å¢é‡å‡çº§è¯¦ç»†æµç¨‹

```mermaid
sequenceDiagram
    participant Client as Duck CLI
    participant Server as å‡çº§æœåŠ¡å™¨
    participant FS as æ–‡ä»¶ç³»ç»Ÿ
    participant Docker as DockeræœåŠ¡
    
    Client->>Server: 1. è¯·æ±‚å‡çº§æ¸…å•
    Server->>Client: 2. è¿”å›å¢å¼ºæ¸…å•
    Client->>Client: 3. åˆ†æå‡çº§ç­–ç•¥
    Client->>Server: 4. ä¸‹è½½è¡¥ä¸åŒ…
    Server->>Client: 5. è¿”å›è¡¥ä¸æ–‡ä»¶
    Client->>Client: 6. éªŒè¯è¡¥ä¸å®Œæ•´æ€§
    Client->>Docker: 7. åœæ­¢æœåŠ¡(å¦‚éœ€è¦)
    Client->>FS: 8. åˆ›å»ºå¤‡ä»½
    Client->>FS: 9. è§£å‹è¡¥ä¸åŒ…
    Client->>FS: 10. æ‰§è¡Œæ–‡ä»¶æ›¿æ¢
    Client->>FS: 11. æ‰§è¡Œæ–‡ä»¶åˆ é™¤
    Client->>Client: 12. æ›´æ–°ç‰ˆæœ¬é…ç½®
    Client->>Docker: 13. å¯åŠ¨æœåŠ¡
    Client->>Client: 14. éªŒè¯å‡çº§ç»“æœ
```

## ğŸ“Š æ•°æ®ç»“æ„è®¾è®¡

### Enhanced Service Manifest (å¢å¼ºæœåŠ¡æ¸…å•)

```json
{
    "version": "0.0.13",
    "release_date": "2025-07-12T13:49:59Z",
    "release_notes": "ç‰ˆæœ¬æ›´æ–°è¯´æ˜",
    
    "packages": {
        "full": {
            "url": "https://legacy-url/docker.zip",
            "hash": "external",
            "signature": "",
            "size": 0
        }
    },
    
    "platforms": {
        "x86_64": {
            "signature": "æ•°å­—ç­¾å",
            "url": "https://packages/x86_64/docker.zip"
        },
        "aarch64": {
            "signature": "æ•°å­—ç­¾å",
            "url": "https://packages/aarch64/docker.zip"
        }
    },
    
    "patch": {
        "version": "0.0.13.2",
        "x86_64": {
            "url": "https://packages/patches/x86_64-patch.tar.gz",
            "hash": "sha256:patch_hash_x86_64",
            "signature": "patch_signature_x86_64",
            "operations": {
                "replace": {
                    "files": ["app/app.jar", "config/application.yml"],
                    "directories": ["front/", "plugins/"]
                },
                "delete": ["front/old-assets/", "config/old.conf"]
            }
        },
        "aarch64": {
            "url": "https://packages/patches/aarch64-patch.tar.gz",
            "hash": "sha256:patch_hash_aarch64",
            "signature": "patch_signature_aarch64",
            "operations": {
                "replace": {
                    "files": ["app.jar", "config/application.yml"],
                    "directories": ["front/", "plugins/"]
                },
                "delete": ["front/old-assets/", "config/old.conf"]
            }
        }
    }
}
```

## ğŸ›¡ï¸ å®‰å…¨æ€§è®¾è®¡

### 1. æ•°å­—ç­¾åéªŒè¯
- æ‰€æœ‰ä¸‹è½½åŒ…ä½¿ç”¨æ•°å­—ç­¾å
- æ”¯æŒç­¾åé“¾éªŒè¯
- é˜²æ­¢ä¸­é—´äººæ”»å‡»

### 2. å®Œæ•´æ€§æ ¡éªŒ
- SHA-256 å“ˆå¸ŒéªŒè¯
- åˆ†å—å®Œæ•´æ€§æ£€æŸ¥
- æŸåæ–‡ä»¶è‡ªåŠ¨é‡è¯•

### 3. åŸå­æ€§æ“ä½œ
- å¤‡ä»½æœºåˆ¶ä¿è¯å›æ»š
- ä¸´æ—¶æ–‡ä»¶åŸå­æ€§æ›¿æ¢
- å¤±è´¥æ—¶å®Œæ•´å›æ»š

### 4. æƒé™æ§åˆ¶
- æœ€å°æƒé™åŸåˆ™
- å®‰å…¨çš„æ–‡ä»¶æ“ä½œ
- è·¯å¾„éå†é˜²æŠ¤

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### 1. å¸¦å®½ä¼˜åŒ–
- **å¢é‡å‡çº§**: å‡å°‘ 60-80% ä¸‹è½½é‡
- **æ¶æ„ç‰¹å®š**: é¿å…æ— ç”¨æ–‡ä»¶ä¸‹è½½
- **æ™ºèƒ½ç¼“å­˜**: å‡å°‘é‡å¤ä¸‹è½½

### 2. å‡çº§é€Ÿåº¦
- **å¹¶å‘ä¸‹è½½**: å¤šçº¿ç¨‹ä¸‹è½½æ”¯æŒ
- **æ–­ç‚¹ç»­ä¼ **: ç½‘ç»œä¸­æ–­è‡ªåŠ¨æ¢å¤
- **é¢„å¤„ç†**: ä¸‹è½½æ—¶å¹¶è¡Œè§£å‹

### 3. ç”¨æˆ·ä½“éªŒ
- **å®æ—¶è¿›åº¦**: è¯¦ç»†è¿›åº¦åé¦ˆ
- **æ™ºèƒ½æ¨è**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç­–ç•¥
- **é”™è¯¯æ¢å¤**: å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### å‡çº§æ—¶é—´å¯¹æ¯”
| å‡çº§ç±»å‹ | æ–‡ä»¶å¤§å° | å‡çº§æ—¶é—´ | å¸¦å®½èŠ‚çœ |
|---------|----------|----------|----------|
| ä¼ ç»Ÿå…¨é‡å‡çº§ | 180MB | 8-15åˆ†é’Ÿ | 0% |
| æ¶æ„ç‰¹å®šå‡çº§ | 120MB | 5-10åˆ†é’Ÿ | 33% |
| å¢é‡å‡çº§ | 35MB | 1-3åˆ†é’Ÿ | 80% |

### ç½‘ç»œç¯å¢ƒé€‚åº”æ€§
| ç½‘ç»œç±»å‹ | å¸¦å®½ | å…¨é‡å‡çº§ | å¢é‡å‡çº§ | ä¼˜åŠ¿ |
|----------|------|----------|----------|------|
| åƒå…†å…‰çº¤ | 1Gbps | 2åˆ†é’Ÿ | 30ç§’ | 4x |
| ç™¾å…†å®½å¸¦ | 100Mbps | 15åˆ†é’Ÿ | 3åˆ†é’Ÿ | 5x |
| ADSL | 20Mbps | 75åˆ†é’Ÿ | 15åˆ†é’Ÿ | 5x |
| 4Gç½‘ç»œ | 10Mbps | 150åˆ†é’Ÿ | 30åˆ†é’Ÿ | 5x |

## ğŸ”® æ‰©å±•æ€§è®¾è®¡

### 1. å¤šç‰ˆæœ¬æ”¯æŒ
- æ”¯æŒå¤šä¸ªè¡¥ä¸ç‰ˆæœ¬å¹¶å­˜
- ç‰ˆæœ¬å›é€€å’Œå‰è¿›
- è‡ªå®šä¹‰å‡çº§è·¯å¾„

### 2. æ’ä»¶åŒ–æ¶æ„
- å¯æ‰©å±•çš„è¡¥ä¸å¤„ç†å™¨
- è‡ªå®šä¹‰æ–‡ä»¶æ“ä½œè§„åˆ™
- ç¬¬ä¸‰æ–¹é›†æˆæ¥å£

### 3. äº‘åŸç”Ÿæ”¯æŒ
- å®¹å™¨åŒ–éƒ¨ç½²æ”¯æŒ
- Kubernetes é›†æˆ
- å¾®æœåŠ¡æ¶æ„é€‚é…

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- ç»„ä»¶åŠŸèƒ½æµ‹è¯•
- ç‰ˆæœ¬è§£ææµ‹è¯•
- ç­–ç•¥é€‰æ‹©æµ‹è¯•
- æ–‡ä»¶æ“ä½œæµ‹è¯•

### 2. é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯å‡çº§æµ‹è¯•
- è·¨æ¶æ„å…¼å®¹æ€§æµ‹è¯•
- ç½‘ç»œå¼‚å¸¸æµ‹è¯•
- å›æ»šåŠŸèƒ½æµ‹è¯•

### 3. æ€§èƒ½æµ‹è¯•
- å‡çº§æ—¶é—´åŸºå‡†æµ‹è¯•
- å†…å­˜ä½¿ç”¨é‡æµ‹è¯•
- å¹¶å‘æ“ä½œæµ‹è¯•
- ç½‘ç»œé€‚åº”æ€§æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-12  
**æ›´æ–°æ—¥æœŸ**: 2025-01-12  
**ä½œè€…**: Duck CLI å¼€å‘å›¢é˜Ÿ 