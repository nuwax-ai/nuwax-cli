# Duck CLI æ€§èƒ½æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

Duck CLI ä½¿ç”¨ [Criterion.rs](https://github.com/bheisler/criterion.rs) è¿›è¡Œå…¨é¢çš„æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼Œæ¶µç›–å‡çº§ç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæ‰€æœ‰æ€§èƒ½æµ‹è¯•

```bash
cd duck-cli
cargo bench
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç»„

```bash
# å‡çº§ç­–ç•¥æ€§èƒ½å¯¹æ¯”
cargo bench upgrade_strategy_comparison

# æ–­ç‚¹ç»­ä¼ æ€§èƒ½æµ‹è¯•
cargo bench resume_download_performance

# å†…å­˜ä½¿ç”¨é‡æµ‹è¯•
cargo bench memory_usage

# å¹¶å‘ä¸‹è½½æ€§èƒ½æµ‹è¯•
cargo bench concurrent_downloads

# ç½‘ç»œæ¡ä»¶å½±å“æµ‹è¯•
cargo bench network_conditions

# ç‰ˆæœ¬ç­–ç•¥é€‰æ‹©æ€§èƒ½æµ‹è¯•
cargo bench version_strategy_selection
```

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. å‡çº§ç­–ç•¥æ€§èƒ½å¯¹æ¯”
**æµ‹è¯•å†…å®¹**ï¼š
- å…¨é‡å‡çº§ vs å¢é‡å‡çº§
- ä¸åŒæ–‡ä»¶å¤§å°çš„æ€§èƒ½å½±å“ (1MB - 1GB)
- è¡¥ä¸åŒ…å¤§å°å¯¹å‡çº§æ—¶é—´çš„å½±å“

**å…³é”®æŒ‡æ ‡**ï¼š
- ä¸‹è½½æ—¶é—´
- å†…å­˜ä½¿ç”¨
- ååé‡ (MB/s)

### 2. æ–­ç‚¹ç»­ä¼ æ€§èƒ½æµ‹è¯•
**æµ‹è¯•å†…å®¹**ï¼š
- ä¸åŒç»­ä¼ ç‚¹çš„æ€§èƒ½ (10%, 25%, 50%, 75%, 90%)
- ç»­ä¼ æ•ˆç‡åˆ†æ
- é‡æ–°ä¸‹è½½ vs ç»­ä¼ çš„æ€§èƒ½å¯¹æ¯”

**å…³é”®æŒ‡æ ‡**ï¼š
- ç»­ä¼ å¼€é”€
- å®Œæˆæ—¶é—´
- ç½‘ç»œæ•ˆç‡

### 3. å†…å­˜ä½¿ç”¨é‡æµ‹è¯•
**æµ‹è¯•å†…å®¹**ï¼š
- ä¸åŒæ–‡ä»¶å¤§å°çš„å†…å­˜æ¶ˆè€—
- å†…å­˜å³°å€¼åˆ†æ
- å†…å­˜æ³„æ¼æ£€æµ‹

**å…³é”®æŒ‡æ ‡**ï¼š
- å³°å€¼å†…å­˜ä½¿ç”¨
- å†…å­˜å¢é•¿ç‡
- åƒåœ¾å›æ”¶å½±å“

### 4. å¹¶å‘ä¸‹è½½æ€§èƒ½æµ‹è¯•
**æµ‹è¯•å†…å®¹**ï¼š
- 1-16 ä¸ªå¹¶å‘ä¸‹è½½
- å¹¶å‘æ•ˆç‡åˆ†æ
- èµ„æºç«äº‰æ£€æµ‹

**å…³é”®æŒ‡æ ‡**ï¼š
- æ€»ä½“ååé‡
- å•ä¸ªä»»åŠ¡å»¶è¿Ÿ
- CPU ä½¿ç”¨ç‡

### 5. ç½‘ç»œæ¡ä»¶å½±å“æµ‹è¯•
**æµ‹è¯•å†…å®¹**ï¼š
- ä¸åŒç½‘ç»œç¯å¢ƒï¼šåƒå…†å…‰çº¤ã€ç™¾å…†å®½å¸¦ã€ADSLã€4Gã€3Gã€æ…¢é€Ÿè¿æ¥
- ç½‘ç»œå»¶è¿Ÿå’Œå¸¦å®½å¯¹æ€§èƒ½çš„å½±å“
- é€‚åº”æ€§åˆ†æ

**å…³é”®æŒ‡æ ‡**ï¼š
- é€‚åº”æ€§è¯„åˆ†
- è¶…æ—¶ç‡
- é‡è¯•æ•ˆç‡

### 6. ç‰ˆæœ¬ç­–ç•¥é€‰æ‹©æ€§èƒ½æµ‹è¯•
**æµ‹è¯•å†…å®¹**ï¼š
- ç‰ˆæœ¬è§£ææ€§èƒ½
- ç­–ç•¥é€‰æ‹©ç®—æ³•æ•ˆç‡
- å†³ç­–æ—¶é—´åˆ†æ

**å…³é”®æŒ‡æ ‡**ï¼š
- è§£æé€Ÿåº¦
- å†³ç­–æ—¶é—´
- ç®—æ³•å¤æ‚åº¦

## ğŸ“ˆ æ€§èƒ½æŠ¥å‘Š

### HTML æŠ¥å‘Š

Criterion ä¼šè‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„ HTML æŠ¥å‘Šï¼š

```bash
# æŠ¥å‘Šä½ç½®
target/criterion/
â”œâ”€â”€ upgrade_strategy_comparison/
â”œâ”€â”€ resume_download_performance/
â”œâ”€â”€ memory_usage/
â”œâ”€â”€ concurrent_downloads/
â”œâ”€â”€ network_conditions/
â””â”€â”€ version_strategy_selection/
```

æ‰“å¼€ `target/criterion/index.html` æŸ¥çœ‹æ±‡æ€»æŠ¥å‘Šã€‚

### ç«ç„°å›¾ï¼ˆæ€§èƒ½åˆ†æï¼‰

å¯ç”¨ `pprof` ç‰¹æ€§åï¼Œä¼šç”Ÿæˆç«ç„°å›¾ç”¨äºæ·±åº¦æ€§èƒ½åˆ†æï¼š

```bash
# ç”Ÿæˆç«ç„°å›¾
cargo bench --features=pprof

# æŸ¥çœ‹ç«ç„°å›¾
target/criterion/*/profile/flamegraph.svg
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ä¿®æ”¹æµ‹è¯•å‚æ•°

ç¼–è¾‘ `benches/upgrade_performance.rs` ä¸­çš„ `PerformanceTestConfig`ï¼š

```rust
pub struct PerformanceTestConfig {
    /// æµ‹è¯•æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    pub file_sizes: Vec<u64>,
    /// å¹¶å‘ä¸‹è½½æ•°é‡
    pub concurrent_downloads: Vec<usize>,
    /// æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
    pub network_latency_ms: u64,
    /// æ¨¡æ‹Ÿç½‘ç»œå¸¦å®½ï¼ˆMB/sï¼‰
    pub network_bandwidth_mbps: f64,
}
```

### è‡ªå®šä¹‰ç½‘ç»œæ¡ä»¶

åœ¨ `bench_network_conditions` å‡½æ•°ä¸­æ·»åŠ æ–°çš„ç½‘ç»œç¯å¢ƒï¼š

```rust
let network_conditions = vec![
    ("custom_network", å»¶è¿Ÿms, å¸¦å®½mbps),
    // ... å…¶ä»–é…ç½®
];
```

## ğŸ“ æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

| æµ‹è¯•åœºæ™¯ | ç›®æ ‡æ€§èƒ½ | å¤‡æ³¨ |
|---------|---------|------|
| å…¨é‡å‡çº§ (100MB) | < 120ç§’ | 50Mbps ç½‘ç»œ |
| å¢é‡å‡çº§ (10MB) | < 15ç§’ | 50Mbps ç½‘ç»œ |
| æ–­ç‚¹ç»­ä¼ å¼€é”€ | < 5% | ç›¸å¯¹äºé‡æ–°ä¸‹è½½ |
| å†…å­˜ä½¿ç”¨ | < 200MB | å³°å€¼å†…å­˜ |
| å¹¶å‘æ•ˆç‡ | > 80% | 4å¹¶å‘æ—¶çš„æ•ˆç‡ |
| ç‰ˆæœ¬è§£æ | < 10ms | å•æ¬¡è§£ææ—¶é—´ |

### æ€§èƒ½å›å½’æ£€æµ‹

Criterion ä¼šè‡ªåŠ¨æ£€æµ‹æ€§èƒ½å›å½’ï¼š

- **æ”¹è¿›** âœ…ï¼šæ€§èƒ½æå‡ > 5%
- **ç¨³å®š** â–ï¼šæ€§èƒ½å˜åŒ– < 5%
- **å›å½’** âŒï¼šæ€§èƒ½ä¸‹é™ > 5%

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼–è¯‘é”™è¯¯**
   ```bash
   # æ›´æ–°ä¾èµ–
   cargo update
   
   # æ¸…ç†é‡å»º
   cargo clean && cargo build
   ```

2. **å†…å­˜ä¸è¶³**
   ```bash
   # å‡å°‘æµ‹è¯•æ–‡ä»¶å¤§å°
   # ç¼–è¾‘ file_sizes é…ç½®
   ```

3. **æµ‹è¯•è¶…æ—¶**
   ```bash
   # å¢åŠ æµ‹è¯•æ—¶é—´
   # ç¼–è¾‘ measurement_time é…ç½®
   ```

### è°ƒè¯•æ¨¡å¼

è¿è¡Œè¯¦ç»†çš„è°ƒè¯•æµ‹è¯•ï¼š

```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
RUST_LOG=debug cargo bench

# å•ä¸ªæµ‹è¯•è°ƒè¯•
cargo bench upgrade_strategy_comparison -- --verbose
```

## ğŸ¯ æœ€ä½³å®è·µ

### æµ‹è¯•ç¯å¢ƒå‡†å¤‡

1. **ç¨³å®šçš„æµ‹è¯•ç¯å¢ƒ**
   - å…³é—­å…¶ä»–ç½‘ç»œå¯†é›†å‹ç¨‹åº
   - ç¡®ä¿ç³»ç»Ÿè´Ÿè½½è¾ƒä½
   - ä½¿ç”¨å›ºå®šçš„ç¡¬ä»¶é…ç½®

2. **åŸºå‡†æ•°æ®æ”¶é›†**
   - è‡³å°‘è¿è¡Œ 3 æ¬¡æµ‹è¯•
   - è®°å½•ç¯å¢ƒå˜é‡ï¼ˆCPUã€å†…å­˜ã€ç½‘ç»œï¼‰
   - ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è·Ÿè¸ªæ€§èƒ½å˜åŒ–

3. **æŒç»­ç›‘æ§**
   - é›†æˆåˆ° CI/CD æµæ°´çº¿
   - è®¾ç½®æ€§èƒ½é˜ˆå€¼å‘Šè­¦
   - å®šæœŸæ›´æ–°åŸºå‡†æ•°æ®

### æ€§èƒ½ä¼˜åŒ–æµç¨‹

1. **è¯†åˆ«ç“¶é¢ˆ**
   ```bash
   cargo bench  # è·å–åŸºå‡†
   # åˆ†æç«ç„°å›¾å’ŒæŠ¥å‘Š
   ```

2. **å®æ–½ä¼˜åŒ–**
   ```bash
   # ä¿®æ”¹ä»£ç 
   cargo bench  # éªŒè¯æ”¹è¿›
   ```

3. **éªŒè¯ç»“æœ**
   ```bash
   # å¯¹æ¯”å‰åæ€§èƒ½æ•°æ®
   # ç¡®ä¿æ²¡æœ‰æ€§èƒ½å›å½’
   ```

## ğŸ“Š CI/CD é›†æˆ

### GitHub Actions ç¤ºä¾‹

```yaml
name: Performance Tests

on:
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥å‡Œæ™¨2ç‚¹

jobs:
  performance:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true
    
    - name: Run benchmarks
      run: |
        cd duck-cli
        cargo bench --message-format=json > bench-results.json
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: duck-cli/target/criterion/
```

## ğŸ”— ç›¸å…³èµ„æº

- [Criterion.rs å®˜æ–¹æ–‡æ¡£](https://bheisler.github.io/criterion.rs/book/)
- [Rust æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://nnethercote.github.io/perf-book/)
- [ç«ç„°å›¾åˆ†ææ•™ç¨‹](https://www.brendangregg.com/flamegraphs.html)
- [å†…å­˜åˆ†æå·¥å…·](https://github.com/koute/memory-profiler) 